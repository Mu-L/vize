import { defineComponent as _defineComponent, type PropType } from 'vue'
import { Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock, createElementBlock as _createElementBlock, createVNode as _createVNode, createElementVNode as _createElementVNode, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, withDirectives as _withDirectives, renderList as _renderList, toDisplayString as _toDisplayString, normalizeClass as _normalizeClass, withCtx as _withCtx, unref as _unref, vShow as _vShow } from "vue"


const _hoisted_1 = /*#__PURE__*/ _createElementVNode("span", { class: "i-lucide:circle-alert w-4 h-4 shrink-0", "aria-hidden": "true" })
const _hoisted_2 = { class: "font-mono text-sm font-medium truncate" }
const _hoisted_3 = { class: "text-xs op-90 dark:op-80 hidden sm:inline" }
const _hoisted_4 = { class: "truncate w-0 flex-1" }
const _hoisted_5 = /*#__PURE__*/ _createElementVNode("span", { class: "i-lucide:circle-alert w-3 h-3", "aria-hidden": "true" })
const _hoisted_6 = /*#__PURE__*/ _createElementVNode("span", { class: "i-lucide:circle-alert w-4 h-4 text-fg-subtle", "aria-hidden": "true" })
const _hoisted_7 = { class: "text-sm text-fg-muted" }
import { SEVERITY_LEVELS } from '#shared/types'
import { SEVERITY_COLORS } from '#shared/utils/severity'
const bannerColor = 'border-amber-600/40 bg-amber-500/10 text-amber-800 dark:text-amber-400'

export default /*@__PURE__*/_defineComponent({
  __name: 'VulnerabilityTree',
  props: {
    packageName: { type: String as PropType<string>, required: true },
    version: { type: String as PropType<string>, required: true }
  },
  setup(__props) {

const props = __props
const { data: vulnTree, status } = useDependencyAnalysis(
  () => props.packageName,
  () => props.version,
)
const isExpanded = shallowRef(false)
const showAllPackages = shallowRef(false)
const showAllVulnerabilities = shallowRef(false)
const hasVulnerabilities = computed(
  () => vulnTree.value && vulnTree.value.vulnerablePackages.length > 0,
)
// Banner - amber for better light mode contrast
const severityLabels = computed(() => ({
  critical: $t('package.vulnerabilities.severity.critical'),
  high: $t('package.vulnerabilities.severity.high'),
  moderate: $t('package.vulnerabilities.severity.moderate'),
  low: $t('package.vulnerabilities.severity.low'),
}))
function getPackageSeverityLabel(severity: Exclude<OsvSeverityLevel, 'unknown'>) {
  return severityLabels.value[severity]
}
const summaryText = computed(() => {
  if (!vulnTree.value) return ''
  const { totalCounts } = vulnTree.value
  return SEVERITY_LEVELS.filter(s => totalCounts[s] > 0)
    .map(s => `${totalCounts[s]} ${getPackageSeverityLabel(s)}`)
    .join(', ')
})
// Styling for each depth level - using accessible colors for both themes
const depthStyles = {
  root: {
    bg: 'bg-amber-500/5 border-is-2 border-is-amber-600',
    text: 'text-fg',
  },
  direct: {
    bg: 'bg-amber-500/5 border-is-2 border-is-amber-500',
    text: 'text-fg-muted',
  },
  transitive: {
    bg: 'bg-amber-500/5 border-is-2 border-is-amber-400',
    text: 'text-fg-muted',
  },
} as const
// Helper to get depth style with fallback
function getDepthStyle(depth: string | undefined) {
  if (depth && depth in depthStyles) {
    return depthStyles[depth as keyof typeof depthStyles]
  }
  return depthStyles.transitive
}

return (_ctx: any,_cache: any) => {
  const _component_DependencyPathPopup = _resolveComponent("DependencyPathPopup")
  const _component_NuxtLink = _resolveComponent("NuxtLink")

  return (_unref(status) === 'success' && hasVulnerabilities.value)
      ? (_openBlock(), _createElementBlock("section", {
        key: 0,
        "aria-labelledby": "vuln-tree-heading",
        class: "relative"
      }, [ _createTextVNode("\n    "), _createTextVNode("\n    "), _createElementVNode("div", {
          role: "alert",
          class: _normalizeClass(["rounded-lg border overflow-hidden", bannerColor])
        }, [ _createTextVNode("\n      "), _createTextVNode("\n      "), _createElementVNode("button", {
            type: "button",
            class: "w-full flex items-center justify-between gap-3 px-4 py-3 text-start transition-colors duration-200 hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-accent/70",
            "aria-expanded": isExpanded.value,
            "aria-controls": "vuln-tree-details",
            onClick: _cache[0] || (_cache[0] = ($event: any) => (isExpanded.value = !isExpanded.value))
          }, [ _createElementVNode("span", { class: "flex items-center gap-2 min-w-0" }, [ _hoisted_1, _createElementVNode("span", _hoisted_2, "\n            " + _toDisplayString(_ctx.$t("package.vulnerabilities.tree_found", {
  	vulns: _unref(vulnTree).totalCounts.total,
  	packages: _unref(vulnTree).vulnerablePackages.length,
  	total: _unref(vulnTree).totalPackages
  }, _unref(vulnTree).totalCounts.total)) + "\n          ", 1 /* TEXT */) ]), _createElementVNode("span", { class: "flex items-center gap-2 shrink-0" }, [ _createElementVNode("span", _hoisted_3, _toDisplayString(summaryText.value), 1 /* TEXT */), _createElementVNode("span", {
                class: _normalizeClass(["i-lucide:chevron-down w-4 h-4 transition-transform duration-200", { 'rotate-180': isExpanded.value }]),
                "aria-hidden": "true"
              }, null, 2 /* CLASS */) ]) ], 8 /* PROPS */, ["aria-expanded"]), _createTextVNode("\n\n      "), _createTextVNode("\n      "), _withDirectives(_createElementVNode("div", {
            id: "vuln-tree-details",
            class: "border-t border-border bg-bg-subtle"
          }, [ _createElementVNode("ul", { class: "divide-y divide-border list-none m-0 p-0" }, [ (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(_unref(vulnTree).vulnerablePackages.slice(0, showAllPackages.value ? undefined : 5), (pkg) => {
                return (_openBlock(), _createElementBlock("li", {
                  key: `${pkg.name}@${pkg.version}`,
                  class: "px-4 py-3",
                  class: _normalizeClass(getDepthStyle(pkg.depth).bg)
                }, [
                  _createElementVNode("div", { class: "flex items-center justify-between gap-2 mb-2" }, [
                    _createElementVNode("div", { class: "flex items-center gap-2 min-w-0 relative" }, [
                      _createTextVNode("\n                "),
                      _createTextVNode("\n                "),
                      (pkg.path && pkg.path.length > 1)
                        ? (_openBlock(), _createBlock(_component_DependencyPathPopup, {
                          key: 0,
                          path: pkg.path
                        }))
                        : _createCommentVNode("v-if", true),
                      _createVNode(_component_NuxtLink, {
                        to: _ctx.packageRoute(pkg.name, pkg.version),
                        class: _normalizeClass(["font-mono text-sm font-medium hover:underline truncate shrink min-w-0", getDepthStyle(pkg.depth).text])
                      }, {
                        default: _withCtx(() => [
                          _createTextVNode("\n                  "),
                          _createTextVNode(_toDisplayString(pkg.name), 1 /* TEXT */),
                          _createTextVNode("@"),
                          _createTextVNode(_toDisplayString(pkg.version), 1 /* TEXT */),
                          _createTextVNode("\n                ")
                        ]),
                        _: 1 /* STABLE */
                      })
                    ]),
                    _createElementVNode("div", { class: "flex items-center gap-1 shrink-0" }, [
                      (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(_unref(SEVERITY_LEVELS).filter(s => pkg.counts[s] > 0), (s) => {
                        return (_openBlock(), _createElementBlock("span", {
                          key: s,
                          class: "px-1.5 py-0.5 text-3xs font-mono rounded border",
                          class: _normalizeClass(_unref(SEVERITY_COLORS)[s])
                        }, "\n                  " + _toDisplayString(pkg.counts[s]) + " " + _toDisplayString(getPackageSeverityLabel(s)) + "\n                ", 3 /* TEXT, CLASS */))
                      }), 128 /* KEYED_FRAGMENT */))
                    ])
                  ]),
                  _createTextVNode("\n            "),
                  _createTextVNode("\n            "),
                  _createElementVNode("ul", { class: "space-y-1 list-none m-0 p-0" }, [
                    (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(pkg.vulnerabilities.slice(0, showAllVulnerabilities.value ? undefined : 2), (vuln) => {
                      return (_openBlock(), _createElementBlock("li", {
                        key: vuln.id,
                        class: "flex items-center gap-2 text-xs text-fg-muted"
                      }, [
                        _createElementVNode("a", {
                          href: vuln.url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          class: "font-mono hover:underline shrink-0"
                        }, "\n                  " + _toDisplayString(vuln.id) + "\n                ", 9 /* TEXT, PROPS */, ["href"]),
                        _createElementVNode("span", _hoisted_4, _toDisplayString(vuln.summary), 1 /* TEXT */),
                        (vuln.fixedIn)
                          ? (_openBlock(), _createBlock(_component_NuxtLink, {
                            key: 0,
                            to: _ctx.packageRoute(pkg.name, vuln.fixedIn),
                            class: "shrink-0 font-mono text-emerald-600 dark:text-emerald-400 hover:underline",
                            title: _ctx.$t('package.vulnerabilities.fixed_in_title', { version: vuln.fixedIn })
                          }, {
                            default: _withCtx(() => [
                              _createTextVNode("\n                  â†’ "),
                              _createTextVNode(_toDisplayString(vuln.fixedIn), 1 /* TEXT */),
                              _createTextVNode("\n                ")
                            ]),
                            _: 1 /* STABLE */
                          }))
                          : _createCommentVNode("v-if", true)
                      ]))
                    }), 128 /* KEYED_FRAGMENT */)),
                    (pkg.vulnerabilities.length > 2 && !showAllVulnerabilities.value)
                      ? (_openBlock(), _createElementBlock("li", {
                        key: 0,
                        class: "text-xs text-fg-subtle"
                      }, [
                        _createElementVNode("button", {
                          type: "button",
                          onClick: _cache[1] || (_cache[1] = ($event: any) => (showAllVulnerabilities.value = true))
                        }, "\n                  " + _toDisplayString(_ctx.$t('package.vulnerabilities.more', { count: pkg.vulnerabilities.length - 2 })) + "\n                ", 1 /* TEXT */)
                      ]))
                      : _createCommentVNode("v-if", true)
                  ])
                ], 2 /* CLASS */))
              }), 128 /* KEYED_FRAGMENT */)) ]), (_unref(vulnTree).vulnerablePackages.length > 5 && !showAllPackages.value) ? (_openBlock(), _createElementBlock("button", {
                key: 0,
                type: "button",
                class: "w-full px-4 py-2 text-xs font-mono text-fg-muted hover:text-fg border-t border-border transition-colors duration-200",
                onClick: _cache[2] || (_cache[2] = ($event: any) => (showAllPackages.value = true))
              }, "\n          " + _toDisplayString(_ctx.$t("package.vulnerabilities.show_all_packages", { count: _unref(vulnTree).vulnerablePackages.length })) + "\n        ", 1 /* TEXT */)) : _createCommentVNode("v-if", true), _createTextVNode("\n\n        "), _createTextVNode("\n        "), (_unref(vulnTree).failedQueries) ? (_openBlock(), _createElementBlock("div", {
                key: 0,
                class: "px-4 py-2 text-xs text-fg-subtle border-t border-border flex items-center gap-2"
              }, [ _hoisted_5, _createElementVNode("span", null, _toDisplayString(_ctx.$t("package.vulnerabilities.packages_failed", _unref(vulnTree).failedQueries)), 1 /* TEXT */) ])) : _createCommentVNode("v-if", true) ], 512 /* NEED_PATCH */), [ [_vShow, isExpanded.value] ]) ], 2 /* CLASS */) ]))
      : (_unref(status) === 'error')
        ? (_openBlock(), _createElementBlock("section", {
          key: 1,
          "aria-labelledby": "vuln-tree-error"
        }, [ _createElementVNode("div", { class: "rounded-lg border border-border bg-bg-subtle px-4 py-3" }, [ _createElementVNode("div", { class: "flex items-center gap-2" }, [ _hoisted_6, _createElementVNode("span", _hoisted_7, "\n          " + _toDisplayString(_ctx.$t('package.vulnerabilities.scan_failed')) + "\n        ", 1 /* TEXT */) ]) ]) ]))
      : _createCommentVNode("v-if", true)
}
}

})
