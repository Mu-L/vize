import { defineComponent as _defineComponent } from 'vue'
import { Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock, createElementBlock as _createElementBlock, createVNode as _createVNode, createElementVNode as _createElementVNode, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, renderList as _renderList, toDisplayString as _toDisplayString, withCtx as _withCtx, unref as _unref } from "vue"


const _hoisted_1 = /*#__PURE__*/ _createElementVNode("div", { my4: "true", border: "t base" })
const _hoisted_2 = /*#__PURE__*/ _createElementVNode("span", { block: "true", "i-ri-download-2-line": "true" })
const _hoisted_3 = /*#__PURE__*/ _createElementVNode("span", { block: "true", "i-ri-upload-2-line": "true" })
import type { UserLogin } from '#shared/types'
import { fileOpen } from 'browser-fs-access'

export default /*@__PURE__*/_defineComponent({
  __name: 'index',
  setup(__props) {

/* eslint-disable no-alert */
const { t } = useI18n()
useHydratedHead({
  title: () => `${t('settings.users.label')} | ${t('nav.settings')}`,
})
const loggedInUsers = useUsers()
async function exportTokens() {
  if (import.meta.server)
    return
  if (!confirm('Please aware that the tokens represent the **full access** to your accounts, and should be treated as sensitive information. Are you sure you want to export the tokens?'))
    return
  const { saveAs } = await import('file-saver')
  const data = {
    '/': 'Generated by Elk, you can import it to Elk to restore the tokens.',
    '//': 'This file represents the **full access** to your accounts, and should be treated as sensitive information.',
    'version': 1,
    'origin': location.origin,
    'users': loggedInUsers.value,
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' })
  saveAs(blob, `elk-users-tokens-${new Date().toISOString().slice(0, 10)}.json`)
}
async function importTokens() {
  if (import.meta.server)
    return
  const file = await fileOpen({
    description: 'Token File',
    mimeTypes: ['application/json'],
  })
  try {
    const content = await file.text()
    const data = JSON.parse(content)
    if (data.version !== 1)
      throw new Error('Invalid version')
    const users = data.users as UserLogin[]
    const newUsers: UserLogin[] = []
    for (const user of users) {
      if (loggedInUsers.value.some(u => u.server === user.server && u.account.id === user.account.id))
        continue
      newUsers.push(user)
    }
    if (newUsers.length === 0) {
      alert('No new users found')
      return
    }
    if (!confirm(`Found ${newUsers.length} new users, are you sure you want to import them?`))
      return
    loggedInUsers.value = [...loggedInUsers.value, ...newUsers]
  }
  catch (e) {
    console.error(e)
    alert('Invalid Elk tokens file')
  }
}

return (_ctx: any,_cache: any) => {
  const _component_MainContent = _resolveComponent("MainContent")
  const _component_MainTitle = _resolveComponent("MainTitle")
  const _component_AccountInfo = _resolveComponent("AccountInfo")

  return (_openBlock(), _createBlock(_component_MainContent, { back: "small-only" }, {
      title: _withCtx(() => [
        _createVNode(_component_MainTitle, {
          as: "h1",
          secondary: ""
        }, {
          default: _withCtx(() => [
            _createTextVNode("\n        "),
            _createTextVNode(_toDisplayString(_ctx.$t('settings.users.label')), 1 /* TEXT */),
            _createTextVNode("\n      ")
          ]),
          _: 1 /* STABLE */
        })
      ]),
      default: _withCtx(() => [
        _createElementVNode("div", { p6: "" }, [
          (_unref(loggedInUsers).length)
            ? (_openBlock(), _createElementBlock(_Fragment, { key: 0 }, [
              _createElementVNode("div", { flex: "~ col gap2" }, [
                (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(_unref(loggedInUsers), (user) => {
                  return (_openBlock(), _createElementBlock("div", { key: user.account.id }, [
                    _createVNode(_component_AccountInfo, {
                      account: user.account,
                      "hover-card": false
                    })
                  ]))
                }), 128 /* KEYED_FRAGMENT */))
              ]),
              _hoisted_1,
              _createElementVNode("button", {
                "btn-text": "",
                flex: "~ gap-2",
                "items-center": "",
                onClick: exportTokens
              }, [
                _hoisted_2,
                _createTextVNode("\n          "),
                _createTextVNode(_toDisplayString(_ctx.$t('settings.users.export')), 1 /* TEXT */),
                _createTextVNode("\n        ")
              ])
            ], 64 /* STABLE_FRAGMENT */))
            : _createCommentVNode("v-if", true),
          _createElementVNode("button", {
            "btn-text": "",
            flex: "~ gap-2",
            "items-center": "",
            onClick: importTokens
          }, [
            _hoisted_3,
            _createTextVNode("\n        "),
            _createTextVNode(_toDisplayString(_ctx.$t('settings.users.import')), 1 /* TEXT */),
            _createTextVNode("\n      ")
          ])
        ])
      ]),
      _: 1 /* STABLE */
    }))
}
}

})
